---
title: "StanfordOutputs"
author: "Adam El-Kadi"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(dplyr)
library(car)

#Adams Path
PlacementInsights <- read.csv('~/Desktop/Capstone/Stanford Data/StanfordPlacementInsights.csv')
Demographics <- read.csv('~/Desktop/Capstone/Stanford Data/StanfordDemographics.csv')
Insights <- read.csv('~/Desktop/Capstone/Stanford Data/StanfordInsights.csv')
```

```{r}
#summary(PlacementInsights)
```

```{r}
#Finding out all Publishing Platforms and printing their distributions
unique(PlacementInsights$PublisherPlatform)
facebook_interactions <- sum(PlacementInsights$PublisherPlatform == "facebook")
instagram_interactions <- sum(PlacementInsights$PublisherPlatform == "instagram")
messenger_interactions <- sum(PlacementInsights$PublisherPlatform == "messenger")
audnet_interactions <- sum(PlacementInsights$PublisherPlatform == "audience_network")
print(paste('The interactions numbers are as follows: facebook - ', facebook_interactions, 
            'instagram - ', instagram_interactions,
            'messenger - ', messenger_interactions, 
            'audience network interactions - ', audnet_interactions))
```

```{r}
#Finding out the proportions of these distributions
total_interactions <- facebook_interactions + instagram_interactions + messenger_interactions + audnet_interactions

facebook_pct <- (facebook_interactions / total_interactions) * 100
instagram_pct <- (instagram_interactions / total_interactions) * 100
messenger_pct <- (messenger_interactions / total_interactions) * 100
audnet_pct <- (audnet_interactions / total_interactions) * 100

print(sprintf("The interaction percentages are as follows: Facebook - %.2f%%, Instagram - %.2f%%, Messenger - %.2f%%, Audience Network - %.2f%%", facebook_pct, instagram_pct, messenger_pct, audnet_pct))
```

```{r}
#Showing average statistics among each combination of Device and Publisher Platforms
PlacementInsights %>%
  group_by(DevicePlatform, PublisherPlatform) %>%
  summarise(
    avg_CTR = mean(CTR, na.rm = TRUE),
    avg_Impressions = mean(Impressions, na.rm = TRUE),
    avg_Clicks = mean(Clicks, na.rm = TRUE),
    avg_LinkClicks = mean(Link.Clicks, na.rm = TRUE),
    count = n()
  ) %>%
  arrange(desc(avg_CTR))
```


```{r}
#Plot showing the Impressions vs clicks, categorized by platforms
ggplot(PlacementInsights, aes(x = Impressions, y = Clicks, color = PublisherPlatform)) +
  geom_point(alpha = 0.7) +
  theme_minimal() +
  labs(title = "Impressions vs Clicks by Publisher Platform", x = "Impressions", y = "Clicks")
```

```{r}
#Plot conveying Click-Through-Rate by Impressions
ggplot(PlacementInsights, aes(x = Impressions, y = CTR, color = DevicePlatform)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  theme_minimal() +
  ylim(0, 50) +
  labs(title = "CTR vs Impressions", x = "Impressions", y = "CTR")
```


```{r}
#Which Publisher Has the Highest CTR on Average
PlacementInsights %>%
  group_by(PublisherPlatform) %>%
  summarise(mean_CTR = mean(CTR, na.rm = TRUE)) %>%
  arrange(desc(mean_CTR))
```


```{r}
impressions_model <- lm(Impressions ~ CTR + Link.Clicks + DevicePlatform + PublisherPlatform, data = PlacementInsights[PlacementInsights$CTR < 20,])
summary(impressions_model)
```

### CTR (-4.49, p < 0.001): A negative relationship with Impressions, suggesting that a higher CTR leads to fewer impressions, possibly due to optimization in ad delivery. The CTR's negative effect suggests that when users engage more (higher CTR), the system may optimize by reducing impressions or reallocating budget elsewhere.

### Link.Clicks (62.14, p < 0.001): A strong positive effect, meaning more link clicks result in more impressions.

### DevicePlatform (mobile_app: 96.45, p < 0.001): Ads shown on mobile apps receive significantly more impressions.

```{r}
vif(impressions_model)
```
### All GVIF^(1/(2*Df)) values are close to 1, meaning there's minimal multicollinearity.

```{r}
ggplot(PlacementInsights, aes(log(Impressions+1), CTR)) + geom_point() + theme_bw()
```

```{r}
ggplot(PlacementInsights, aes(log(Impressions+1), Link.Clicks)) + geom_point() + theme_bw()
```

```{r}
#summary(PlacementInsights$Impressions)
```

```{r}
PlacementInsights$LCTR <- PlacementInsights$Link.Clicks/PlacementInsights$Impressions
PlacementInsights$LCTR[is.infinite(PlacementInsights$LCTR)] <- 0
#summary(PlacementInsights$LCTR)
ggplot(PlacementInsights, aes(log(Impressions+1), LCTR)) + geom_point() + theme_bw()
```

```{r}
#Top Performing Device-Publisher Combinations
PlacementInsights %>%
  group_by(DevicePlatform, PublisherPlatform) %>%
  summarise(
    avg_CTR = mean(CTR, na.rm = TRUE),
    avg_Clicks = mean(Clicks, na.rm = TRUE)
  ) %>%
  filter(avg_CTR > 1) %>%
  arrange(desc(avg_CTR))
```

```{r}
#Which Publisher Has the Highest CTR on Average
PlacementInsights %>%
  group_by(PublisherPlatform) %>%
  summarise(mean_CTR = mean(CTR, na.rm = TRUE)) %>%
  arrange(desc(mean_CTR))
```

```{r}
# Lets rerun some of the CTR functions with the new LCTR
# Top Performing Device-Publisher Combinations
PlacementInsights %>%
  group_by(DevicePlatform, PublisherPlatform) %>%
  summarise(
    avg_LCTR = mean(LCTR, na.rm = TRUE),
    avg_Link.Clicks = mean(Link.Clicks, na.rm = TRUE)
  ) %>%
  arrange(desc(avg_LCTR))
```

# Recommendations:
# Focus ad spend on Facebook mobile app for maximum clicks.
# Improve Instagram engagement, especially on mobile web.
# Consider optimizing ad content or targeting strategy for Messenger, as it's currently yielding no clicks.
# Leverage Audience Network on desktop for high CTR efficiency in niche targeting.

```{r}
PlacementInsights %>%
  group_by(PublisherPlatform) %>%
  summarise(mean_LCTR = mean(LCTR, na.rm = TRUE)) %>%
  arrange(desc(mean_LCTR))
```

Groups by campaignId and campaign name -- with LCTR
```{r}
Campaign_Grouped <- PlacementInsights %>%
  group_by(CampaignId, CampaignName) %>%
  summarise(
    avg_LCTR = mean(LCTR, na.rm = TRUE),
    avg_Clicks = mean(Clicks, na.rm = TRUE)
  ) %>%
  arrange(desc(avg_LCTR))
```

Bar chart by Campaign Id -- Let's look at sport
```{r}
ggplot(Campaign_Grouped, aes(x = reorder(CampaignId, avg_LCTR), y = avg_LCTR)) +
  geom_bar(stat = "identity", fill = "blue") +
  labs(title = "Average LCTR by Campaign", x = "Campaign Name", y = "Average LCTR") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

Group by Sport
```{r}
library(dplyr)
library(ggplot2)
library(stringr)  # For str_detect()

sports_data <- PlacementInsights %>%
  mutate(Sport = case_when(
    str_detect(CampaignName, "MBB|Men's Basketball") ~ "Men's Basketball",
    str_detect(CampaignName, "WBB|Women's Basketball") ~ "Women's Basketball",
    str_detect(CampaignName, "FB|Football") ~ "Football",
    str_detect(CampaignName, "SB|Softball") ~ "Softball",
    str_detect(CampaignName, "BSB|Baseball") ~ "Baseball",
    str_detect(CampaignName, "MS|Men's Soccer") ~ "Men's Soccer",
    str_detect(CampaignName, "WS|Women's Soccer") ~ "Women's Soccer",
    str_detect(CampaignName, "V24|Volleyball") ~ "Volleyball",
    str_detect(CampaignName, "WG|Gymnastics") ~ "Gymnastics",
    str_detect(CampaignName, "MWP|Water Polo") ~ "Water Polo",
    str_detect(CampaignName, "Track|XC") ~ "Track & Field / XC",
    TRUE ~ "Other"
  ))

```

Add Groups in for Bar Chart
```{r}
Grouped_Sports <- sports_data %>%
  group_by(Sport) %>%
  summarise(
    avg_LCTR = mean(LCTR, na.rm = TRUE),
    avg_Clicks = mean(Clicks, na.rm = TRUE),
    count = n()  # Count number of campaigns per sport
  ) %>%
  arrange(desc(avg_LCTR))

head(Grouped_Sports)

```

```{r}
ggplot(Grouped_Sports, aes(x = reorder(Sport, avg_LCTR), y = avg_LCTR)) +
  geom_bar(stat = "identity", fill = "blue") +
  labs(title = "Average LCTR by Sport", x = "Sport", y = "Average LCTR") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate labels for readability

```
Looks at impressions by sport
```{r}
Grouped_Sports <- sports_data %>%
  group_by(Sport, CampaignName, AdsetName) %>%
  summarise(
    avg_LCTR = mean(LCTR, na.rm = TRUE),
    avg_Clicks = mean(Clicks, na.rm = TRUE),
    avg_impressions = mean(Impressions),
    count = n(), # Count number of campaigns per sport
  ) %>%
  arrange(desc(avg_LCTR))

head(Grouped_Sports)
```

```{r}
Grouped_Sports_sorted <- Grouped_Sports %>%
  filter(Sport != "Other") %>%
  arrange(desc(avg_impressions))  # Ensure data is sorted correctly

ggplot(Grouped_Sports_sorted, 
       aes(x = reorder(Sport, avg_impressions), y = avg_impressions)) +  # Correct sorting
  geom_bar(stat = "identity", fill = "blue") +
  labs(title = "Average Impression by Sport", x = "Sport", y = "Average Impressions") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
Take out other (for now)
```{r}
Grouped_Sports_sorted <- Grouped_Sports %>%
  filter(Sport != "Other") %>%
  arrange(desc(avg_LCTR))  # Ensure data is sorted correctly

ggplot(Grouped_Sports_sorted, 
       aes(x = reorder(Sport, avg_LCTR), y = avg_LCTR)) +  # Correct sorting
  geom_bar(stat = "identity", fill = "blue") +
  labs(title = "Average LCTR by Sport", x = "Sport", y = "Average LCTR") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


Grouped_Sports_sorted <- Grouped_Sports %>%
  filter(Sport != "Other") %>%
  arrange(desc(avg_impressions))  # Ensure data is sorted correctly

ggplot(Grouped_Sports_sorted, 
       aes(x = reorder(Sport, avg_impressions), y = avg_impressions)) +  # Correct sorting
  geom_bar(stat = "identity", fill = "blue") +
  labs(title = "Average Impression by Sport", x = "Sport", y = "Average Impressions") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```



```{r}
Limpressions_model <- lm(Impressions ~ LCTR + Link.Clicks + DevicePlatform + PublisherPlatform, data = PlacementInsights[PlacementInsights$LCTR < 20,])
summary(Limpressions_model)
```

# Big Goal: Build a model on ROI, maybe monetize clicks 

```{r}
c_vals <- unique(PlacementInsights[, c("CampaignId", "AdId" )])
```

```{r}
place_res <- as.data.frame(matrix(NA, nrow = length(c_vals), ncol = 4))
revenue <- as.data.frame(matrix(NA, nrow = length(c_vals), ncol = 6))

spend <- rep(NA, length(c_vals))
#revenue <- rep(NA, length(c_vals))


for(i in 1:length(c_vals)){
  place_res[i,] <- colSums(PlacementInsights[which(PlacementInsights$CampaignId == c_vals$CampaignId[i] &
                                                   PlacementInsights$AdId == c_vals$AdId[i]  ), c(11:14)])
  spend[i] <-  sum(Demographics$Spend[which(Demographics$CampaignID == c_vals$CampaignId[i] &
                                        Demographics$AdId == c_vals$AdId[i])])
  revenue[i,] <- colSums(Insights[which(Insights$CampaignId == c_vals$CampaignId[i] &
                                                   Insights$AdId == c_vals$AdId[i]  ), c(27:32)])
  
}

names(place_res)<- names(PlacementInsights)[c(11:14)]
names(revenue) <- names(Insights)[c(27:32)]
```


```{r}
res <- cbind.data.frame(c_vals, place_res, spend, revenue)
```



